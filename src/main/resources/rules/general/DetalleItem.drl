package rules;

import org.openublpe.xmlbuilder.models.input.general.AbstractInputDocumentModel;
import org.openublpe.xmlbuilder.models.output.general.AbstractOutputDocumentModel;
import org.openublpe.xmlbuilder.models.input.general.DetalleInputModel;
import org.openublpe.xmlbuilder.models.output.general.DetalleOutputModel;

import java.math.BigDecimal;

import org.openublpe.xmlbuilder.models.ubl.Catalog;
import org.openublpe.xmlbuilder.models.ubl.Catalog7;
import org.openublpe.xmlbuilder.models.ubl.Catalog16;

global java.math.BigDecimal IGV;

dialect "java"

rule "Detalle Item"
when
    $input : AbstractInputDocumentModel(detalle != null)
    $output : AbstractOutputDocumentModel()
    $inputDetalle: DetalleInputModel()
then
    DetalleOutputModel outputDetalle = new DetalleOutputModel();
    $output.getDetalle().add(outputDetalle);

    outputDetalle.setDescripcion($inputDetalle.getDescripcion());
    outputDetalle.setUnidadMedida($inputDetalle.getUnidadMedida() != null ? $inputDetalle.getUnidadMedida() : "NIU");
    outputDetalle.setCantidad($inputDetalle.getCantidad());
    outputDetalle.setPrecioUnitario($inputDetalle.getPrecioUnitario());

    outputDetalle.setTipoIgv(
            $inputDetalle.getTipoIGV() != null
                ? Catalog.valueOfCode(Catalog7.class, $inputDetalle.getTipoIGV()).get()
                : Catalog7.GRAVADO_OPERACION_ONEROSA
    );

    outputDetalle.setTipoPrecio(
            outputDetalle.getTipoIgv().isOperacionOnerosa()
                ? Catalog16.PRECIO_UNITARIO_INCLUYE_IGV
                : Catalog16.VALOR_FERENCIAL_UNITARIO_EN_OPERACIONES_NO_ONEROSAS
    );


    // CÃ¡lculos

    outputDetalle.setTotal(
            $inputDetalle.getCantidad().multiply($inputDetalle.getPrecioUnitario())
    );

    outputDetalle.setIgv(
            outputDetalle.getTipoIgv().isGravado() ? outputDetalle.getTotal().multiply(IGV) : BigDecimal.ZERO
    );


    outputDetalle.setValorUnitario(
            $inputDetalle.getPrecioUnitario().multiply(BigDecimal.ONE.subtract(IGV))
    );

    outputDetalle.setSubtotal(
            $inputDetalle.getCantidad().multiply(outputDetalle.getValorUnitario())
    );

end